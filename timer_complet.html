<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Révélation des départements</title>

<style>
body {
  background:#111;
  color:white;
  font-family:sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
  padding:20px;
  font-size: 50px;
  height: 95svh;
}
a{
  text-decoration: none;
  color: black;
}

button, input{
  border-radius: 30px;
}
canvas {
  background:#111;
  width: 900px;
  
  margin-bottom: 10px;
}

.controls {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  justify-content:center;
}

button {
  padding:8px 16px;
  margin: 40px;
  font-size: 40px;
}
#timerDuration{
  padding: 2px; 
  width: 150px; 
  font-size: 35px;
  text-align: center;
}
#timer { font-size:60px;
font-weight: bold;
margin: 40px; }

.stats { display:flex; gap:20px; font-size: 40px; }

#temps{
  display: flex;
  gap: 20px;
  font-size: 40px;
  align-items: center;
}
</style>
</head>

<body>

<div id="temps">
<label>Timer : </label>
  <input id="timerDuration" type="number" value="30" >
  <span>min</span>
</div>
<div class="controls">
  
  <button><a href="index.html">Accueil</a></button>
  <button id="start">Démarrer</button>
  <button id="reset">Reset total</button>
  
</div>

<div class="stats">
  
  <div id="progress">Progression : 0%</div>
  
</div>
<div id="timer">Temps : 0s</div>
<canvas id="canvas"></canvas>

<script>
/* ===================== DONNÉES ===================== */

const departments = [
  { num:"01", name:"Ain" }, { num:"02", name:"Aisne" },
  { num:"03", name:"Allier" }, { num:"04", name:"Alpes-de-Haute-Provence" },
  { num:"05", name:"Hautes-Alpes" }, { num:"06", name:"Alpes-Maritimes" },
  
];

const BLOCK_SIZE = 1;

/* ===================== ÉTAT GLOBAL ===================== */

const state = {
  deptIndex: 0,
  revealed: 0,
  totalTime: 0,
  running: false,
  startTime: null,
  blocks: [],
  img: null,
  intervalId: null,
  realStartTimestamp: null
};

/* ===================== DOM ===================== */
const son = new Audio('notif.mp3');
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const timerDiv = document.getElementById("timer");


const progressDiv = document.getElementById("progress");

const startBtn = document.getElementById("start");
const resetBtn = document.getElementById("reset");
const timerInput = document.getElementById("timerDuration");

const animInput = 3600;

/* ===================== STORAGE ===================== */

function loadGlobal() {
  const stored = localStorage.getItem("global");
  return stored ? JSON.parse(stored) : {
    deptIndex: 0,
    completed: []
  };
}

function saveGlobal(data) {
  localStorage.setItem("global", JSON.stringify(data));
}

function loadDept(num) {
  const stored = localStorage.getItem("dept_" + num);
  return stored ? JSON.parse(stored) : null;
}

function saveDept(num) {
  localStorage.setItem("dept_" + num, JSON.stringify({
    revealed: state.revealed,
    totalTime: state.totalTime
  }));
}

function saveTimerState() {
  if (state.running && state.realStartTimestamp) {
    localStorage.setItem("activeTimer", JSON.stringify({
      deptNum: departments[state.deptIndex].num,
      startTimestamp: state.realStartTimestamp,
      totalTime: state.totalTime,
      timerDuration: parseFloat(timerInput.value) * 60
    }));
  }
}

function loadTimerState() {
  const stored = localStorage.getItem("activeTimer");
  return stored ? JSON.parse(stored) : null;
}

function clearTimerState() {
  localStorage.removeItem("activeTimer");
}

/* ===================== LOGIQUE ===================== */

function loadDepartment() {
  const global = loadGlobal();
  state.deptIndex = global.deptIndex;

  const dept = departments[state.deptIndex];
  

  state.revealed = 0;
  state.totalTime = 0;
  state.blocks = [];
  state.running = false;

  state.img = new Image();
  state.img.src = `departements/dept_${dept.num}.png`;

  

  state.img.onload = () => {
    canvas.width = state.img.width;
    canvas.height = state.img.height;

    for (let y=0;y<canvas.height;y+=BLOCK_SIZE) {
      for (let x=0;x<canvas.width;x+=BLOCK_SIZE) {
        state.blocks.push({x,y});
      }
    }

    state.blocks.sort(()=>Math.random()-0.5);

    const saved = loadDept(dept.num);
    if (saved) {
      state.revealed = Math.min(saved.revealed, state.blocks.length);
      state.totalTime = saved.totalTime;
      redraw();
    }

    updateUI();
    
    checkForActiveTimer();
  };
}

function checkForActiveTimer() {
  const timerState = loadTimerState();
  if (!timerState) return;
  
  const dept = departments[state.deptIndex];
  if (timerState.deptNum !== dept.num) {
    clearTimerState();
    return;
  }
  
  const now = Date.now();
  const elapsedReal = (now - timerState.startTimestamp) / 1000;
  
  state.totalTime = timerState.totalTime;
  timerInput.value = (timerState.timerDuration / 60).toFixed(0);
  
  if (elapsedReal < timerState.timerDuration) {
    state.realStartTimestamp = timerState.startTimestamp;
    state.startTime = performance.now() - (elapsedReal * 1000);
    state.running = true;
    state.intervalId = setInterval(loop, 16);
  } else {
    const total = state.totalTime + timerState.timerDuration;
    const target = Math.floor((total / animInput) * state.blocks.length);
    state.revealed = Math.min(target, state.blocks.length);
    redraw();
    updateUI();
    clearTimerState();
  }
}

function redraw() {
  for (let i=0;i<state.revealed;i++) {
    const b = state.blocks[i];
    ctx.drawImage(state.img, b.x,b.y,1,1, b.x,b.y,1,1);
  }
}

function updateUI() {
  const global = loadGlobal();
  

  const pct = ((state.revealed/state.blocks.length)*100||0).toFixed(1);
  progressDiv.textContent = `Progression : ${pct}%`;
}

function completeDepartment() {
  const global = loadGlobal();
  const dept = departments[state.deptIndex].num;

  if (!global.completed.includes(dept))
    global.completed.push(dept);

  global.deptIndex++;
  saveGlobal(global);

  ctx.clearRect(0,0,canvas.width,canvas.height);
  clearTimerState();

  if (global.deptIndex >= departments.length) {
    
    timerDiv.textContent = "Bravo";
    return;
  }

  loadDepartment();
}

/* ===================== ANIMATION ===================== */

function loop() {
  if (!state.running) return;

  const now = Date.now();
  const elapsedReal = (now - state.realStartTimestamp) / 1000;
  const timerDurationSeconds = parseFloat(timerInput.value) * 60;
  const timeLeft = Math.max(0, timerDurationSeconds - elapsedReal);
  const tempsrestantmin = Math.floor(timeLeft / 60);
  const tempsrestantsec = Math.floor(timeLeft % 60).toString().padStart(2, "0");

  timerDiv.textContent = `Temps : ${tempsrestantmin}m ${tempsrestantsec}s`;

  const total = state.totalTime + elapsedReal;
  const target = Math.floor(
    (total / animInput) * state.blocks.length
  );

  while (state.revealed < target && state.revealed < state.blocks.length) {
    const b = state.blocks[state.revealed];
    ctx.drawImage(state.img,b.x,b.y,1,1,b.x,b.y,1,1);
    state.revealed++;
  }

  updateUI();

  if (state.revealed >= state.blocks.length) {
    state.running = false;
    clearInterval(state.intervalId);
    clearTimerState();
    son.play();
    saveDept(departments[state.deptIndex].num);
    setTimeout(completeDepartment, 1200);
    return;
  }

  if (timeLeft <= 0) {
    state.running = false;
    clearInterval(state.intervalId);
    state.totalTime += elapsedReal;
    clearTimerState();
    son.play();
    saveDept(departments[state.deptIndex].num);
    return;
  }
}

/* ===================== EVENTS ===================== */

startBtn.onclick = () => {
  if (state.running) return;
  state.realStartTimestamp = Date.now();
  state.startTime = performance.now();
  state.running = true;
  
  saveTimerState();
  
  state.intervalId = setInterval(loop, 16);
};

resetBtn.onclick = () => {
  if (!confirm("Tout supprimer ?")) return;
  if (state.running) {
    clearInterval(state.intervalId);
    state.running = false;
  }
  localStorage.clear();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  loadDepartment();
};

setInterval(() => {
  if (state.running) {
    saveTimerState();
  }
}, 1000);

document.addEventListener('visibilitychange', () => {
  if (document.hidden && state.running) {
    saveTimerState();
  } else if (!document.hidden && state.running) {
    loop();
  }
});

/* ===================== INIT ===================== */

loadDepartment();
</script>

</body>
</html>