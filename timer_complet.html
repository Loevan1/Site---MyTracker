<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Révélation des départements</title>

<style>
body {
  background:#111;
  color:white;
  font-family:sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
  padding:20px;
  font-size: 50px;
}

canvas {
  background:#111;
  width: 900px;
  border: 2px solid #222;
  margin-bottom: 10px;
}

.controls {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  justify-content:center;
}

button {
  padding:8px 16px;
  margin: 40px;
  font-size: 40px;
}
#timerDuration{
  padding: 2px; 
  width: 150px; 
  font-size: 35px;
  text-align: center;
}
#timer { font-size:60px;
font-weight: bold;
margin: 40px; }

.stats { display:flex; gap:20px; font-size: 40px; }

#temps{
  display: flex;
  gap: 20px;
  font-size: 40px;
}
</style>
</head>

<body>

<div id="temps">
<label>Timer : </label>
  <input id="timerDuration" type="number" value="1800" min="1" step="1">
</div>
<div class="controls">
  
  
  <button id="start">Démarrer</button>
  <button id="reset">Reset total</button>
</div>

<div class="stats">
  <div id="completedCount">Complétés : 0/101 </div>
  <div id="progress">Progression : 0%</div>
  
</div>
<div id="timer">Temps : 0s</div>
<canvas id="canvas"></canvas>

<script>
/* ===================== DONNÉES ===================== */

const departments = [
  { num:"01", name:"Ain" }, { num:"02", name:"Aisne" },
  { num:"03", name:"Allier" }, { num:"04", name:"Alpes-de-Haute-Provence" },
  { num:"05", name:"Hautes-Alpes" }, { num:"06", name:"Alpes-Maritimes" },
  
];

const BLOCK_SIZE = 1;

/* ===================== ÉTAT GLOBAL ===================== */

const state = {
  deptIndex: 0,
  revealed: 0,
  totalTime: 0,
  running: false,
  startTime: null,
  blocks: [],
  img: null
};

/* ===================== DOM ===================== */
const son = new Audio('notif.mp3');
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const timerDiv = document.getElementById("timer");

const completedDiv = document.getElementById("completedCount");
const progressDiv = document.getElementById("progress");

const startBtn = document.getElementById("start");
const resetBtn = document.getElementById("reset");
const timerInput = document.getElementById("timerDuration");
const animInput = 10;

/* ===================== STORAGE ===================== */

function loadGlobal() {
  return JSON.parse(localStorage.getItem("global")) || {
    deptIndex: 0,
    completed: []
  };
}

function saveGlobal(data) {
  localStorage.setItem("global", JSON.stringify(data));
}

function loadDept(num) {
  return JSON.parse(localStorage.getItem("dept_" + num)) || null;
}

function saveDept(num) {
  localStorage.setItem("dept_" + num, JSON.stringify({
    revealed: state.revealed,
    totalTime: state.totalTime
  }));
}

/* ===================== LOGIQUE ===================== */

function loadDepartment() {
  const global = loadGlobal();
  state.deptIndex = global.deptIndex;

  const dept = departments[state.deptIndex];
  

  state.revealed = 0;
  state.totalTime = 0;
  state.blocks = [];
  state.running = false;

  state.img = new Image();
  state.img.src = `departements/dept_${dept.num}.png`;

  

  state.img.onload = () => {
    canvas.width = state.img.width;
    canvas.height = state.img.height;

    for (let y=0;y<canvas.height;y+=BLOCK_SIZE) {
      for (let x=0;x<canvas.width;x+=BLOCK_SIZE) {
        state.blocks.push({x,y});
      }
    }

    state.blocks.sort(()=>Math.random()-0.5);

    const saved = loadDept(dept.num);
    if (saved) {
      state.revealed = Math.min(saved.revealed, state.blocks.length);
      state.totalTime = saved.totalTime;
      redraw();
    }

    updateUI();
  };
}

function redraw() {
  for (let i=0;i<state.revealed;i++) {
    const b = state.blocks[i];
    ctx.drawImage(state.img, b.x,b.y,1,1, b.x,b.y,1,1);
  }
}

function updateUI() {
  const global = loadGlobal();
  completedDiv.textContent =
    `Complétés : ${global.completed.length}/101`;

  const pct = ((state.revealed/state.blocks.length)*100||0).toFixed(1);
  progressDiv.textContent = `Progression : ${pct}%`;
}

function completeDepartment() {
  const global = loadGlobal();
  const dept = departments[state.deptIndex].num;

  if (!global.completed.includes(dept))
    global.completed.push(dept);

  global.deptIndex++;
  saveGlobal(global);

  ctx.clearRect(0,0,canvas.width,canvas.height);

  if (global.deptIndex >= departments.length) {
    
    timerDiv.textContent = "Bravo";
    return;
  }

  loadDepartment();
}

/* ===================== ANIMATION ===================== */

function loop(t) {
  if (!state.running) return;

  if (!state.startTime) state.startTime = t;
  const elapsed = (t - state.startTime)/1000;
  const timeLeft = Math.max(0, timerInput.value - elapsed);

  timerDiv.textContent = `Temps : ${timeLeft.toFixed(0)}s`;

  const total = state.totalTime + elapsed;
  const target = Math.floor(
    (total / animInput) * state.blocks.length
  );

  while (state.revealed < target && state.revealed < state.blocks.length) {
    const b = state.blocks[state.revealed];
    ctx.drawImage(state.img,b.x,b.y,1,1,b.x,b.y,1,1);
    state.revealed++;
  }

  updateUI();

  if (state.revealed >= state.blocks.length) {
    state.running = false;
    son.play();
    saveDept(departments[state.deptIndex].num);
    setTimeout(completeDepartment, 1200);
    return;
  }

  if (timeLeft <= 0) {
    state.running = false;
    state.totalTime += elapsed;
    son.play();
    saveDept(departments[state.deptIndex].num);
    return;
  }

  requestAnimationFrame(loop);
}

/* ===================== EVENTS ===================== */

startBtn.onclick = () => {
  if (state.running) return;
  state.startTime = null;
  state.running = true;
  requestAnimationFrame(loop);
};

resetBtn.onclick = () => {
  if (!confirm("Tout supprimer ?")) return;
  localStorage.clear();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  loadDepartment();
};

/* ===================== INIT ===================== */

loadDepartment();
</script>

</body>
</html>
